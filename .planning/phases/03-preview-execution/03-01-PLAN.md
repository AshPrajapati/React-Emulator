---
phase: 03-preview-execution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/Preview.jsx
  - src/utils/generatePreviewHTML.js
  - src/App.jsx
autonomous: false

must_haves:
  truths:
    - "User sees React component render in preview pane"
    - "Preview updates automatically when code changes"
    - "Preview runs in sandboxed iframe (isolated execution)"
    - "React hooks (useState, useEffect, etc.) work in preview"
  artifacts:
    - path: "src/components/Preview.jsx"
      provides: "Sandboxed iframe wrapper component"
      min_lines: 20
    - path: "src/utils/generatePreviewHTML.js"
      provides: "HTML document generator with React runtime"
      exports: ["generatePreviewHTML"]
    - path: "src/App.jsx"
      provides: "Preview integration replacing placeholder"
      contains: "Preview"
  key_links:
    - from: "src/App.jsx"
      to: "Preview component"
      via: "transformedCode prop"
      pattern: "<Preview.*transformedCode"
    - from: "src/components/Preview.jsx"
      to: "generatePreviewHTML"
      via: "import and call"
      pattern: "generatePreviewHTML\\(transformedCode\\)"
    - from: "src/utils/generatePreviewHTML.js"
      to: "iframe srcdoc"
      via: "HTML string with React CDN"
      pattern: "react.*react-dom"
---

<objective>
Create sandboxed iframe preview execution with React rendering.

Purpose: Execute transformed JSX code in isolated environment so users can see their React components render live.
Output: Preview component that renders user code with React 18 support, HTML generator that provides React runtime, and integrated App showing live preview.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-preview-execution/03-CONTEXT.md
@.planning/phases/02-transformation-pipeline/02-01-SUMMARY.md

# Current state
@src/App.jsx
@src/utils/transform.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Preview Component</name>
  <files>src/components/Preview.jsx</files>
  <action>
Create `src/components/Preview.jsx` - a React component that renders transformed code in a sandboxed iframe.

Component signature:
```jsx
function Preview({ transformedCode }) {
  // Use iframe with srcdoc attribute
  // Sandbox with "allow-scripts" only (no same-origin, no forms, etc.)
  // Dark background (#1e1e1e) matching editor theme
}
```

Implementation details:
- Accept `transformedCode` prop (the Babel-transformed JavaScript)
- Use iframe element with `sandbox="allow-scripts"` attribute
- Set iframe srcdoc to HTML document (from generatePreviewHTML utility - will create in Task 2)
- Style iframe: 100% width/height, no border, dark background
- Update srcdoc whenever transformedCode changes (useEffect)
- Handle empty/null transformedCode gracefully (show empty frame)

Why sandbox="allow-scripts" only: Maximum isolation while allowing React to execute. No form submission, no popup windows, no same-origin access to parent.

Export as default.
  </action>
  <verify>
File exists at `src/components/Preview.jsx` and exports default component.
Check: `grep -q "export default" src/components/Preview.jsx && echo "OK"`
  </verify>
  <done>
Preview component created with iframe using sandbox="allow-scripts", accepts transformedCode prop, styled with dark theme.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create HTML Document Generator</name>
  <files>src/utils/generatePreviewHTML.js</files>
  <action>
Create `src/utils/generatePreviewHTML.js` - utility function that generates a complete HTML document with React runtime and user code.

Function signature:
```js
export function generatePreviewHTML(transformedCode) {
  // Returns HTML string with React CDN, ReactDOM, and user code execution
}
```

HTML structure:
```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    body {
      margin: 0;
      padding: 16px;
      background: #1e1e1e;
      color: #d4d4d4;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    #root { width: 100%; height: 100%; }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React 18 from CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <script type="module">
    // User's transformed code wrapped in execution context
    const { createElement: h } = React;
    const { createRoot } = ReactDOM;

    ${transformedCode}

    // Auto-detect and render exported component
    // Look for: export default Component
    // Or: top-level JSX expression
    const rootElement = document.getElementById('root');
    const root = createRoot(rootElement);

    // Find the default export and render it
    // (Will be available as a global after user code executes)
    if (typeof Component !== 'undefined') {
      root.render(h(Component));
    }
  </script>
</body>
</html>
```

Implementation notes:
- Use React 18 production builds from unpkg CDN
- Dark theme matching editor (#1e1e1e background, #d4d4d4 text)
- Wrap user code in try/catch for render errors (Phase 4 will handle this better)
- Auto-detect default export - look for `export default` in transformed code and extract component name
- If no default export, try to find any React.createElement calls and render first one
- Keep simple - just get basic rendering working (error handling is Phase 4)

Export as named function.
  </action>
  <verify>
File exists at `src/utils/generatePreviewHTML.js` and exports generatePreviewHTML function.
Test: Call function with sample code and verify it returns HTML string with React CDN.
```bash
node -e "import('./src/utils/generatePreviewHTML.js').then(m => console.log(m.generatePreviewHTML('console.log(123)').includes('react')))"
```
  </verify>
  <done>
HTML generator created that produces complete document with React 18 CDN, dark theme styling, and user code execution wrapper.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire Preview to App</name>
  <files>src/App.jsx</files>
  <action>
Update `src/App.jsx` to replace preview placeholder with actual Preview component.

Changes:
1. Import Preview component: `import Preview from './components/Preview';`
2. Replace the current preview-placeholder div with Preview component
3. Pass transformedCode to Preview: `<Preview transformedCode={transformedCode} />`
4. Only show Preview when no transform error (keep error display as-is)
5. Remove console.log statements (were for debugging Phase 2)

Current structure to update:
```jsx
<div className="preview-placeholder">
  {transformError ? (
    <div className="transform-error">...</div>
  ) : (
    <span>Preview Ready</span>  // REPLACE THIS with <Preview />
  )}
</div>
```

New structure:
```jsx
<div className="preview-placeholder">
  {transformError ? (
    <div className="transform-error">...</div>
  ) : (
    <Preview transformedCode={transformedCode} />
  )}
</div>
```

Keep all existing:
- State variables (code, transformedCode, transformError)
- Debounced transformation logic
- Editor integration
- Split pane layout
- Transform error display

Remove:
- `console.log('Transformed:', result.code);`
- `console.log('Transform error:', result.error);`
  </action>
  <verify>
Build succeeds: `npm run build`
Dev server runs: `npm run dev` (don't wait, just start it)
Check imports: `grep -q "import Preview" src/App.jsx && echo "OK"`
Check usage: `grep -q "<Preview" src/App.jsx && echo "OK"`
  </verify>
  <done>
App.jsx updated with Preview component replacing placeholder, transformedCode wired to Preview, console.logs removed, build succeeds.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete preview execution pipeline with sandboxed iframe rendering. The editor now has live React preview that updates as you type.
  </what-built>
  <how-to-verify>
1. Open browser to dev server (should be running from Task 3)
2. Verify initial render:
   - Left pane: Monaco editor with "Hello World" code
   - Right pane: Preview showing "Hello World" heading (NOT "Preview Ready" text)
3. Test live updates:
   - Change "Hello World" to "Hello React"
   - Wait 300ms for debounce
   - Preview should update to show "Hello React"
4. Test React hooks:
   - Replace code with counter component:
   ```jsx
   import { useState } from 'react';

   function Counter() {
     const [count, setCount] = useState(0);
     return (
       <div>
         <p>Count: {count}</p>
         <button onClick={() => setCount(count + 1)}>Increment</button>
       </div>
     );
   }

   export default Counter;
   ```
   - Preview should render counter
   - Click "Increment" button
   - Counter should increase (verifies useState works)
5. Test sandbox isolation:
   - Preview should be in iframe
   - Preview should have dark background (#1e1e1e)
   - Text should be light colored (#d4d4d4)

Expected behavior:
- Preview updates automatically on code change (with 300ms delay)
- React components render correctly
- Hooks work (useState, etc.)
- Dark theme matches editor
- No console errors

Common issues:
- If preview shows "Preview Ready": Preview component not rendering
- If preview is blank: Check browser console for errors
- If hooks don't work: React CDN not loading correctly
- If preview doesn't update: Check transformedCode is passing to Preview
  </how-to-verify>
  <resume-signal>Type "approved" if preview renders React components correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
**Build verification:**
- `npm run build` succeeds without errors
- Preview component exists and exports default
- generatePreviewHTML utility exists and exports function
- App.jsx imports and uses Preview component

**Runtime verification:**
- Dev server runs without errors
- Initial code renders in preview (not placeholder text)
- Preview updates when code changes (300ms debounce)
- React hooks work (useState, useEffect)
- Preview isolated in iframe with dark theme

**Integration verification:**
- transformedCode flows: Editor -> transform -> Preview
- Transform errors still display correctly
- Preview only shows when no transform error
- Layout preserved (split pane still works)
</verification>

<success_criteria>
**Phase 3 complete when:**
1. Preview component renders transformedCode in sandboxed iframe
2. HTML generator provides complete React 18 runtime environment
3. User can write React components with hooks and see them render
4. Preview updates automatically as user types (debounced 300ms)
5. Dark theme consistent with editor aesthetic
6. No regressions to editor or transformation pipeline

**Measurable outcomes:**
- PREV-01: Preview updates automatically ✓
- PREV-02: Preview runs in sandboxed iframe ✓
- PREV-03: React hooks work ✓
- User can write and see React components live ✓
</success_criteria>

<output>
After completion, create `.planning/phases/03-preview-execution/03-01-SUMMARY.md`

Include:
- What was built (Preview component, HTML generator, integration)
- Technical decisions (sandbox level, React CDN version, auto-detect strategy)
- Files modified (Preview.jsx, generatePreviewHTML.js, App.jsx)
- Verification results (all checks passed)
- Next steps (Phase 4: Error handling for runtime errors)
</output>
